// ==UserScript==
// @name Piazza Revert
// @description Revert Piazza to the old user interface
// @version 0.5.0
// @author embeddedt
// @homepage https://github.com/embeddedt/piazza-revert
// @supportURL https://github.com/embeddedt/piazza-revert/issues
// @match https://piazza.com/*
// @downloadURL https://github.com/embeddedt/piazza-revert/raw/refs/heads/main/revert.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @icon https://www.google.com/s2/favicons?sz=64&domain=piazza.com
// @namespace https://github.com/embeddedt
// @updateURL https://github.com/embeddedt/piazza-revert/raw/refs/heads/main/revert.user.js
// ==/UserScript==

(()=>{"use strict";console.log("Bootstrapped Piazza Revert"),GM_addStyle('#react_root .folderbar-wrapper,#topbar,.main-content #content-holder,.main-content .questions-and-answers #qanda-content>div{max-width:none}#react_root,.btn{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif}#content-holder .feed-wrapper{padding-left:0;margin-left:0}#content-holder #react_feed #feed_list_wrapper{border-radius:0px;margin-bottom:0px}#react_feed #feed_list_wrapper #feed_list ul li.feed_item .content .snippet{font-family:"Lucida Grande",Lucida,Tahoma,Verdana,Arial,sans-serif;color:#666}#feed_search_bar{max-width:400px;padding-left:4px}#site-nav{margin-left:0 !important}.class-menu-wrapper{margin-left:10em}#react_feed{padding:0}#qanda-content>div>hr{border-top:none;height:1em}*{letter-spacing:normal !important}:root{--qa-section-border-color: #dee2e6;--qa-footer-background-color: rgb(242, 242, 242);--qa-followup-background-color: #f6f7f6;--qa-followup-reply-background-color: #f2f2f2;--qa-avatar-border-color: #fff;--qa-article-border-color: #cccccc}html[data-darkreader-scheme=dark]{--qa-section-border-color: #383d3f;--qa-footer-background-color: #222526;--qa-followup-background-color: #1d1f20;--qa-followup-reply-background-color: #1f2223;--qa-avatar-border-color: #303436;--qa-article-border-color: #3e4446}.main-content .questions-and-answers{background-color:#eaeef4}[data-darkreader-scheme=dark] .main-content .questions-and-answers{background-color:#212425}[data-darkreader-scheme=dark] #react_feed #feed_list_wrapper #feed_list ul li.feed_item .content .snippet{color:#a8a095}[data-darkreader-scheme=dark] #react_feed #feed_list_wrapper #feed_list ul li.feed_item.selected{background-color:#3c3200}#react_feed #feed_list_wrapper #feed_list ul li.feed_item .feed_item_dropdown_selector{top:auto;left:auto;bottom:4px;right:4px}#react_feed+.questions-and-answers #qanda-content{margin-left:0px;padding-right:9px}#qanda-content{padding:0 8px}#post-header>button[aria-label=Close]{display:none}.main-content .questions-and-answers #qanda-content #post-header{border-top-left-radius:5px;border-top-right-radius:5px;border-bottom-left-radius:0;border-bottom-right-radius:0;box-shadow:0 1px 4px rgba(0,0,0,.15);border:1px solid var(--qa-section-border-color);padding:.5rem 1rem !important;margin:0 .5rem}.main-content .questions-and-answers #qanda-content .post-footer{border-top:1px solid var(--qa-section-border-color);background:none}.main-content .questions-and-answers #qanda-content article[data-id=i_answer],.main-content .questions-and-answers #qanda-content article[data-id=s_answer]{background-color:#fff}[data-darkreader-scheme=dark] .main-content .questions-and-answers #qanda-content article[data-id=i_answer],[data-darkreader-scheme=dark] .main-content .questions-and-answers #qanda-content article[data-id=s_answer]{background-color:#181a1b}.main-content .questions-and-answers #qanda-content article#qaContentViewId{border-top-left-radius:0;border-top-right-radius:0;box-shadow:0 1px 4px rgba(0,0,0,.15);padding-top:.75rem;margin:0 .5rem;padding-bottom:0 !important;border:1px solid var(--qa-section-border-color);border-top:none;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.main-content .questions-and-answers #qanda-content .followup_container{margin-left:.5rem;margin-right:.5rem}article.answer{box-shadow:0 1px 4px rgba(0,0,0,.15);padding:0 !important;border-radius:5px}article.answer>header{padding-left:1rem;padding-right:1rem;padding-bottom:.5rem}article.answer>footer,.main-content .questions-and-answers #qanda-content .post-footer{padding-top:.25rem;padding-bottom:.25rem;background-color:var(--qa-footer-background-color);border-bottom-left-radius:5px;border-bottom-right-radius:5px;margin-left:0 !important;margin-right:0 !important;margin-bottom:0 !important}article.answer>footer>div>div.pl-4{padding-left:.5rem !important;margin-top:0 !important}article.answer{position:relative;border:1px solid var(--qa-article-border-color)}.main-content .questions-and-answers #qanda-content .answer .update_text[data-id=contributors]{margin:0;text-align:right;position:absolute;bottom:.5rem;right:1rem}article.answer>div:first-of-type{margin-left:0 !important}article.answer>.content{margin:0 !important;padding-right:1.5rem !important;padding-top:1rem;padding-bottom:1rem;border-top:1px solid var(--qa-section-border-color);border-bottom:1px solid var(--qa-section-border-color)}article.answer button.btn-ghost,.main-content .questions-and-answers #qanda-content .post-footer button.btn-ghost{background-color:#1370c4;color:#fff;align-items:center}article.answer button.btn-ghost:hover:not(:disabled),.main-content .questions-and-answers #qanda-content .post-footer button.btn-ghost:hover:not(:disabled){background-color:#0f5391}article.answer button.btn-ghost>svg,.main-content .questions-and-answers #qanda-content .post-footer button.btn-ghost>svg{display:none}article.followup_container>header{padding-top:.5rem;margin-bottom:0 !important}article.followup_container .followup{background:var(--qa-followup-background-color)}article.followup_container .followup_reply{background:var(--qa-followup-reply-background-color)}article.followup_container .followup .followup_content_wrapper>.border-left{border-left:0 !important}.main-content .questions-and-answers #qanda-content article .content .avatar{border-radius:0;border:2px solid var(--qa-avatar-border-color)}.followup.private{border:9px solid #343a40}.followup.private .badge.bg-dark{border-top-left-radius:0;border-bottom-left-radius:0}.us-settings-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.5);z-index:9998}.us-settings-dialog{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#fff;padding:20px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:9999;max-width:90vw;max-height:80vh;overflow-y:auto}.us-settings-dialog h2{margin-top:0;font-size:18px}.us-settings-dialog .setting-container{margin-bottom:12px}.us-settings-dialog label{display:flex;align-items:center;font-size:14px}.us-settings-dialog label input[type=checkbox]{margin-right:8px}.us-settings-dialog label input[type=number]{margin-top:4px;padding:2px 4px;font-size:14px}.us-settings-dialog .close-btn{margin-top:10px;padding:6px 12px;border-radius:4px;border:1px solid #888;background:#f0f0f0;cursor:pointer}#qanda-content .render-html-content img{max-width:150px;height:auto;cursor:pointer}');const e=new class{constructor(e="piazzaRevertUserscriptSettings"){this.storageKey=e,this.settings={},this.load()}addSetting({key:e,label:t,type:o="boolean",defaultValue:n=!1}){e in this.settings||(this.settings[e]=n),this._meta||(this._meta={}),this._meta[e]={label:t,type:o}}set(e,t){this.settings[e]=t,this.save()}get(e){return this.settings[e]}save(){localStorage.setItem(this.storageKey,JSON.stringify(this.settings))}load(){const e=localStorage.getItem(this.storageKey);if(e)try{this.settings=JSON.parse(e)}catch{}}showDialog(){const e=document.getElementById("userscript-settings-dialog");e&&e.remove();const t=document.createElement("div");t.className="us-settings-overlay";const o=document.createElement("div");o.className="us-settings-dialog";const n=document.createElement("h2");n.textContent="Settings",o.appendChild(n);for(const e in this._meta){const t=this._meta[e],n=document.createElement("div");if(n.className="setting-container","boolean"===t.type){const o=document.createElement("label"),a=document.createElement("input");a.type="checkbox",a.checked=!!this.get(e),a.addEventListener("change",t=>this.set(e,t.target.checked)),o.appendChild(a),o.appendChild(document.createTextNode(t.label)),n.appendChild(o)}else if("number"===t.type){const o=document.createElement("label");o.style.flexDirection="column",o.style.fontSize="14px",o.textContent=t.label;const a=document.createElement("input");a.type="number",a.value=this.get(e),a.addEventListener("change",t=>this.set(e,parseFloat(t.target.value))),o.appendChild(a),n.appendChild(o)}o.appendChild(n)}const a=document.createElement("button");a.className="close-btn",a.textContent="Close",a.addEventListener("click",()=>{o.remove(),t.remove()}),o.appendChild(a),document.body.appendChild(t),document.body.appendChild(o),t.addEventListener("click",()=>{o.remove(),t.remove()})}};e.addSetting({key:"enableHoverPreview",label:"Enable Hover Preview",defaultValue:!0}),e.addSetting({key:"enableFancyGallery",label:"Enable Fancybox Gallery",defaultValue:!0}),e.addSetting({key:"hoverPreviewDelay",label:"Hover Preview Delay (ms)",type:"number",defaultValue:400}),function(e,t){const o=document.querySelector(e);o?t(o):new MutationObserver((o,n)=>{for(const a of o)for(const o of a.addedNodes){if(!(o instanceof HTMLElement))continue;if(o.matches(e))return n.disconnect(),void t(o);const a=o.querySelector(e);if(a)return n.disconnect(),void t(a)}}).observe(document.body,{childList:!0,subtree:!0})}("#piazza_homepage_id",t=>{const o=document.createElement("a");o.href="#",o.textContent="Userscript settings",o.className="dropdown-item",o.style.cursor="pointer",o.addEventListener("click",t=>{t.preventDefault(),e.showDialog()}),t.insertAdjacentElement("afterend",o)});const t="#qanda-content .render-html-content img";!function(){const e=new Map;let t=null;function o(t){if(!t||"object"!=typeof t)return;const n=[t.tag_good,t.tag_endorse].find(Boolean);t.id&&Array.isArray(n)&&n.length>0&&e.set(t.id,n);for(const e in t)if(t.hasOwnProperty(e)){const n=t[e];Array.isArray(n)?n.forEach(e=>o(e)):"object"==typeof n&&null!==n&&o(n)}}async function n(){const t=window.location.pathname.match(/\/class\/([^\/]+)\/post\/([^\/]+)/);if(e.clear(),t){const e=t[1],n=t[2],a=await fetch("https://piazza.com/logic/api?method=content.get",{credentials:"include",headers:{Accept:"application/json, text/plain, */*",Pragma:"no-cache","Cache-Control":"no-cache","CSRF-Token":unsafeWindow.CSRF_TOKEN},referrer:window.location.href,body:JSON.stringify({method:"content.get",params:{cid:n,nid:e,student_view:null}}),method:"POST",mode:"cors"});o(await a.json())}console.log(e)}function a(e){const t=e.querySelector('div[id$="_render"]');return null!=t?t.id.replace(/_render$/,""):"unknown"}async function r(o){if(o.classList.contains("endorsement-patched"))return;let r;t!=window.location.pathname&&(await n(),t=window.location.pathname);const s=o.closest('article[aria-label="Instructor Answer"]');if(s)r=a(s);else{const e=o.closest('article[id="qaContentViewId"]');if(null!=e)r=a(e);else{const e=o.closest("div[id]");null!=e&&(r=e.id)}}let i=e.get(r)??[];i=i.filter(e=>e.admin).map(e=>e.name),console.log("Found endorsement:",o,"id:",r,"info:",i),i.length>1&&(o.classList.add("endorsement-patched"),o.textContent="Endorsed by Instructors ("+i.join(", ")+")")}new MutationObserver(async e=>{for(const t of e){for(const e of t.addedNodes)if(1===e.nodeType){e.matches("div.badge-success > b")&&e.textContent.trim().startsWith("Endorsed by Instructor")&&await r(e);const t=e.querySelectorAll?.("div.badge-success > b");for(const e of t)e&&e.textContent.trim().startsWith("Endorsed by Instructor")&&await r(e)}if("characterData"===t.type){const e=t.target.parentElement;e?.matches("div.badge-success > b")&&e.textContent.trim().startsWith("Endorsed by Instructor")&&await r(e)}}}).observe(document.body,{childList:!0,subtree:!0,characterData:!0})}(),function(){if(!e.get("enableHoverPreview"))return;let o,n,a=0,r=0;document.addEventListener("mousemove",e=>{a=e.clientX,r=e.clientY,o&&(o.style.top=r+20+"px",o.style.left=a+20+"px")}),document.addEventListener("mouseover",e=>{const s=e.target.closest(t);s&&(n=setTimeout(()=>{o=document.createElement("div"),o.style.position="absolute",o.style.zIndex="9999",o.style.border="1px solid #ccc",o.style.background="#fff",o.style.padding="4px",o.style.boxShadow="0 4px 12px rgba(0,0,0,0.2)",o.style.borderRadius="6px";const e=document.createElement("img");e.src=s.src,e.style.maxWidth="500px",e.style.maxHeight="500px",e.style.display="block",o.appendChild(e),document.body.appendChild(o),o.style.top=r+20+"px",o.style.left=a+20+"px",s.addEventListener("mouseout",()=>{clearTimeout(n),o&&(o.remove(),o=null)},{once:!0})},400))}),document.addEventListener("mouseout",e=>{e.target.closest(t)&&clearTimeout(n)})}(),GM_addElement("link",{rel:"stylesheet",href:"https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0/dist/fancybox/fancybox.css"}),GM_addElement("script",{src:"https://cdn.jsdelivr.net/npm/@fancyapps/ui@6.0/dist/fancybox/fancybox.umd.js"}),e.get("enableFancyGallery")&&document.addEventListener("click",e=>{const o=e.target.closest(t);if(!o)return;e.preventDefault();const n=o.closest(".render-html-content")||document,a=Array.from(n.querySelectorAll(t)),r=a.map(e=>({src:e.src,thumbSrc:e.src,caption:e.alt||e.title||""})),s=a.indexOf(o);Fancybox.show(r,{startIndex:s,Toolbar:{display:["zoom","slideshow","fullscreen","download","close"]}})})})();