// ==UserScript==
// @name Piazza Revert
// @description Revert Piazza to the old user interface
// @version 0.5.0-build.2025-11-01T18:17:53.623Z
// @author embeddedt
// @homepage https://github.com/embeddedt/piazza-revert
// @supportURL https://github.com/embeddedt/piazza-revert/issues
// @match https://piazza.com/*
// @connect piazza.com
// @downloadURL https://github.com/embeddedt/piazza-revert/raw/refs/heads/main/revert.user.js
// @grant GM_addStyle
// @grant GM_addElement
// @grant GM_xmlhttpRequest
// @icon https://www.google.com/s2/favicons?sz=64&domain=piazza.com
// @namespace https://github.com/embeddedt
// @updateURL https://github.com/embeddedt/piazza-revert/raw/refs/heads/main/revert.meta.js
// ==/UserScript==

(()=>{"use strict";window.addEventListener("SettingsChanged",e=>{const{key:t,newValue:o}=e.detail;if("boolean"==typeof o){const e="us-feature-"+t,n=document.documentElement.classList;o?n.add(e):n.remove(e)}});const e=new class{constructor(e="piazzaRevertUserscriptSettings"){this.storageKey=e,this.settings={},this.load(),this._fireInitialEvents()}addSetting({key:e,label:t,type:o="boolean",defaultValue:n=!1}){e in this.settings||(this.settings[e]=n,this._fireEvent(e,null,n)),this._meta||(this._meta={}),this._meta[e]={label:t,type:o}}set(e,t){const o=this.settings[e];this.settings[e]=t,this.save(),this._fireEvent(e,o,t)}get(e){return this.settings[e]}save(){localStorage.setItem(this.storageKey,JSON.stringify(this.settings))}load(){const e=localStorage.getItem(this.storageKey);if(e)try{this.settings=JSON.parse(e)}catch{}}_fireEvent(e,t,o){const n=new CustomEvent("SettingsChanged",{detail:{key:e,oldValue:t,newValue:o}});window.dispatchEvent(n)}_fireInitialEvents(){for(const e in this.settings)this._fireEvent(e,null,this.settings[e])}showDialog(){const e=document.getElementById("userscript-settings-dialog");e&&e.remove();const t=document.createElement("div");t.className="us-settings-overlay";const o=document.createElement("div");o.className="us-settings-dialog";const n=document.createElement("h2");n.textContent="Settings",o.appendChild(n);for(const e in this._meta){const t=this._meta[e],n=document.createElement("div");if(n.className="setting-container","boolean"===t.type){const o=document.createElement("label"),r=document.createElement("input");r.type="checkbox",r.checked=!!this.get(e),r.addEventListener("change",t=>this.set(e,t.target.checked)),o.appendChild(r),o.appendChild(document.createTextNode(t.label)),n.appendChild(o)}else if("number"===t.type){const o=document.createElement("label");o.style.flexDirection="column",o.style.fontSize="14px",o.textContent=t.label;const r=document.createElement("input");r.type="number",r.value=this.get(e),r.addEventListener("change",t=>this.set(e,parseFloat(t.target.value))),o.appendChild(r),n.appendChild(o)}o.appendChild(n)}const r=document.createElement("button");r.className="close-btn",r.textContent="Close",r.addEventListener("click",()=>{o.remove(),t.remove()}),o.appendChild(r),document.body.appendChild(t),document.body.appendChild(o),t.addEventListener("click",()=>{o.remove(),t.remove()})}};e.addSetting({key:"smallerImagesInPosts",label:"Smaller Images in Posts",defaultValue:!0}),e.addSetting({key:"enableHoverPreview",label:"Enable Image Hover Preview",defaultValue:!0}),e.addSetting({key:"hoverPreviewDelay",label:"Hover Preview Delay (ms)",type:"number",defaultValue:400}),e.addSetting({key:"enableFancyGallery",label:"Enable Image Enlarge on Click",defaultValue:!0}),e.addSetting({key:"heicImageDecoding",label:"Auto-Convert Image Links",defaultValue:!0});const t=new Map;function o(e,o="script"){const n=e+"|"+o;let r=t.get(n);return void 0===r&&(r=function(e,t){return new Promise((o,n)=>{let r;if("script"==t)r=document.createElement("script"),r.src=e;else{if("style"!=t)return void n({error:"Unknown package type: "+t});r=document.createElement("link"),r.rel="stylesheet",r.type="text/css",r.href=e}r.onload=o,r.onerror=n,document.head.appendChild(r)})}(e,o),t.set(n,r)),r}const n=new Set(["jpeg","jpg","png","heic"]);function r(t){if(!e.get("heicImageDecoding"))return;const r=t.getAttribute("href");if(!r)return;const a=t.textContent.trim(),i=r.toLowerCase(),s=i.substring(i.lastIndexOf(".")+1);if(!n.has(s))return;const d=a.toLowerCase().substring(a.lastIndexOf(".")+1);if(n.has(d))if("heic"==s){console.log("Trying to decode HEIC",r);const e=o("https://cdn.jsdelivr.net/npm/heic-to@1.3.0/dist/iife/heic-to.js");GM_xmlhttpRequest({method:"GET",url:r,responseType:"arraybuffer",redirect:"follow",onload:async function(o){const n=new Blob([o.response],{type:"image/heic"});await e,unsafeWindow.HeicTo({blob:n,type:"image/jpeg"}).then(e=>{const o=Array.isArray(e)?e[0]:e,n=URL.createObjectURL(o),r=document.createElement("img");r.src=n,r.alt=a,t.replaceWith(r)}).catch(e=>{console.error("Failed to convert HEIC:",e)})},onerror:function(e){console.error("Failed to fetch HEIC:",e)}})}else{const e=document.createElement("img");e.src=r,e.alt=a,t.replaceWith(e)}}if(new MutationObserver(e=>{for(const t of e)for(const e of t.addedNodes)e.nodeType===Node.ELEMENT_NODE&&("A"===e.tagName?r(e):e.querySelectorAll?.("a").forEach(r))}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll("a").forEach(r),void 0!==unsafeWindow.tinymce){function s(e){const t=e.getDoc(),o=t.createElement("style");o.textContent=".mce-content-body:not([dir=rtl]) blockquote{border-left:2px solid #6d737b;padding-left:1rem}",t.head.appendChild(o)}const d="tox-statusbar__resize-handle";function c(e,t){e.addEventListener("pointerdown",o=>{console.log("start resize"),o.preventDefault(),e.setPointerCapture(o.pointerId);const n=o.clientY,r=t.offsetHeight,a=e=>{const o=e.clientY-n,a=Math.max(100,r+o);t.style.height=a+"px"},i=t=>{console.log("finish resize"),e.releasePointerCapture(t.pointerId),e.removeEventListener("pointermove",a),e.removeEventListener("pointerup",i)};e.addEventListener("pointermove",a),e.addEventListener("pointerup",i)})}tinymce.on("AddEditor",e=>{const t=e.editor;t.on("init",()=>{s(t);const e=t.getContainer();if(!e)return void console.warn("editor container does not exist");const o=e.querySelector("."+d);if(o)return void c(o,e);const n=new MutationObserver(t=>{for(const o of t)for(const t of o.addedNodes){if(t.classList&&t.classList.contains(d))return c(t,e),void n.disconnect();if(t.querySelector){const o=t.querySelector("."+d);if(o)return c(o,e),void n.disconnect()}}});n.observe(e,{childList:!0,subtree:!0})})})}const a="5.4.4",i="#qanda-content .render-html-content img";!function(){if(!e.get("enableHoverPreview"))return;let t,o,n=0,r=0;function a(){const e=t.getBoundingClientRect();let o=n+20,a=r+20;o=Math.max(0,Math.min(o,document.body.clientWidth-e.width)),a=Math.max(0,Math.min(a,document.body.clientHeight-e.height)),t.style.transform=`translate(${o}px, ${a}px)`}document.addEventListener("mousemove",e=>{n=e.clientX,r=e.clientY,t&&a()}),document.addEventListener("mouseover",n=>{const r=n.target.closest(i);r&&(o=setTimeout(()=>{t=document.createElement("div"),t.classList.add("us-image-hover-preview-container");const e=document.createElement("img");e.src=r.src,t.appendChild(e),document.body.appendChild(t),a(),r.addEventListener("mouseout",()=>{clearTimeout(o),t&&(t.remove(),t=null)},{once:!0})},e.get("hoverPreviewDelay")))}),document.addEventListener("mouseout",e=>{e.target.closest(i)&&clearTimeout(o)})}(),document.addEventListener("click",async t=>{if(!e.get("enableFancyGallery"))return;const n=t.target.closest(i);if(!n)return;t.preventDefault();const r=n.closest(".render-html-content")||document,s=Array.from(r.querySelectorAll(i)),d=s.map(e=>({src:e.src,width:e.naturalWidth,height:e.naturalHeight,alt:e.alt||e.title||""})),c=s.indexOf(n);await Promise.all([o(`https://cdn.jsdelivr.net/npm/photoswipe@${a}/dist/umd/photoswipe.umd.min.js`),o(`https://cdn.jsdelivr.net/npm/photoswipe@${a}/dist/photoswipe.css`,"style")]),new PhotoSwipe({dataSource:d,index:c}).init()}),console.log("Bootstrapped Piazza Revert"),GM_addStyle('#react_root .folderbar-wrapper,#topbar,.main-content #content-holder:has(#react_feed),.main-content .questions-and-answers #qanda-content>div{max-width:none}#react_root,.btn{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif}#content-holder .feed-wrapper{padding-left:0;margin-left:0}#content-holder #react_feed #feed_list_wrapper{border-radius:0px;margin-bottom:0px}#react_feed #feed_list_wrapper #feed_list ul li.feed_item .content .snippet{font-family:"Lucida Grande",Lucida,Tahoma,Verdana,Arial,sans-serif;color:#666}body.dark-mode #react_feed #feed_list_wrapper #feed_list ul li.feed_item .content .snippet{color:#999}#feed_search_bar{max-width:400px;padding-left:4px}#site-nav{margin-left:0 !important}.class-menu-wrapper{margin-left:10em}#react_feed{padding:0}#qanda-content>div>hr{border-top:none;height:1em}*{letter-spacing:normal !important}:root{--qa-section-border-color: #dee2e6;--qa-footer-background-color: rgb(242, 242, 242);--qa-followup-background-color: #f6f7f6;--qa-followup-reply-background-color: #f2f2f2;--qa-avatar-border-color: #fff;--qa-article-border-color: #cccccc}body.dark-mode{--qa-section-border-color: #383d3f;--qa-footer-background-color: #222526;--qa-followup-background-color: #1d1f20;--qa-followup-reply-background-color: #1f2223;--qa-avatar-border-color: #303436;--qa-article-border-color: #3e4446}#react_feed #feed_list_wrapper #feed_list ul li.feed_item.selected{background-color:#fff6c6}body.dark-mode #react_feed #feed_list_wrapper #feed_list ul li.feed_item.selected{background-color:#3c3200}#react_feed #feed_list_wrapper #feed_list ul li.feed_item .feed_item_dropdown_selector{top:auto;left:auto;bottom:4px;right:4px}#react_feed+.questions-and-answers #qanda-content{margin-left:0px;padding-right:9px}#qanda-content{padding:0 8px}#post-header>button[aria-label=Close]{display:none}.main-content .questions-and-answers #qanda-content #post-header{border-top-left-radius:5px;border-top-right-radius:5px;border-bottom-left-radius:0;border-bottom-right-radius:0;box-shadow:0 1px 4px rgba(0,0,0,.15);border:1px solid var(--qa-section-border-color);padding:.5rem 1rem !important;margin:0 .5rem}.main-content .questions-and-answers #qanda-content .post-footer{border-top:1px solid var(--qa-section-border-color);background:none}.main-content .questions-and-answers #qanda-content article[data-id=i_answer],.main-content .questions-and-answers #qanda-content article[data-id=s_answer],#qaContentViewId{background-color:#fff}body.dark-mode .main-content .questions-and-answers #qanda-content article[data-id=i_answer],body.dark-mode .main-content .questions-and-answers #qanda-content article[data-id=s_answer],body.dark-mode #qaContentViewId{background-color:#181a1b}.main-content .questions-and-answers #qanda-content article#qaContentViewId{border-top-left-radius:0;border-top-right-radius:0;box-shadow:0 1px 4px rgba(0,0,0,.15);padding-top:.75rem;margin:0 .5rem;padding-bottom:0 !important;border:1px solid var(--qa-section-border-color);border-top:none;border-bottom-left-radius:5px;border-bottom-right-radius:5px}.main-content .questions-and-answers #qanda-content .followup_container{margin-left:.5rem;margin-right:.5rem}article.answer{box-shadow:0 1px 4px rgba(0,0,0,.15);padding:0 !important;border-radius:5px}article.answer>header{padding-left:1rem;padding-right:1rem;padding-bottom:.5rem}article.answer>footer,.main-content .questions-and-answers #qanda-content .post-footer{padding-top:.25rem;padding-bottom:.25rem;background-color:var(--qa-footer-background-color);border-bottom-left-radius:5px;border-bottom-right-radius:5px;margin-left:0 !important;margin-right:0 !important;margin-bottom:0 !important}article.answer>footer>div>div.pl-4{padding-left:.5rem !important;margin-top:0 !important}article.answer{position:relative;border:1px solid var(--qa-article-border-color)}.main-content .questions-and-answers #qanda-content .answer .update_text[data-id=contributors]{margin:0;text-align:right;position:absolute;bottom:.5rem;right:1rem}article.answer>div:first-of-type{margin-left:0 !important}article.answer>.content{margin:0 !important;padding-right:1.5rem !important;padding-top:1rem;padding-bottom:1rem;border-top:1px solid var(--qa-section-border-color);border-bottom:1px solid var(--qa-section-border-color)}article.answer button.btn-ghost,.main-content .questions-and-answers #qanda-content .post-footer button.btn-ghost{background-color:#1370c4;color:#fff;align-items:center}article.answer button.btn-ghost:hover:not(:disabled),.main-content .questions-and-answers #qanda-content .post-footer button.btn-ghost:hover:not(:disabled){background-color:#0f5391}article.answer button.btn-ghost>svg,.main-content .questions-and-answers #qanda-content .post-footer button.btn-ghost>svg{display:none}article.followup_container>header{padding-top:.5rem;margin-bottom:0 !important}article.followup_container .followup{background:var(--qa-followup-background-color)}article.followup_container .followup_reply{background:var(--qa-followup-reply-background-color)}article.followup_container .followup .followup_content_wrapper>.border-left{border-left:0 !important}.main-content .questions-and-answers #qanda-content article .content .avatar{border-radius:0;border:2px solid var(--qa-avatar-border-color)}.followup.private{border:9px solid #343a40}.followup.private .badge.bg-dark{border-top-left-radius:0;border-bottom-left-radius:0}.us-settings-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.5);z-index:9998}.us-settings-dialog{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#fff;padding:20px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.3);z-index:9999;max-width:90vw;max-height:80vh;overflow-y:auto;color:#333}.us-settings-dialog h2{margin-top:0;font-size:18px}.us-settings-dialog .setting-container{margin-bottom:12px}.us-settings-dialog label{display:flex;align-items:center;font-size:14px}.us-settings-dialog label input[type=checkbox]{margin-right:8px}.us-settings-dialog label input[type=number]{margin-top:4px;padding:2px 4px;font-size:14px}.us-settings-dialog .close-btn{margin-top:10px;padding:6px 12px;border-radius:4px;border:1px solid #888;background:#f0f0f0;cursor:pointer;appearance:none;color:#333}.us-feature-smallerImagesInPosts body .render-html-content img{max-width:300px;height:auto;cursor:pointer}body .render-html-content img,img.pswp__img{background-color:#fff}.us-image-hover-preview-container{position:absolute;top:0;left:0;transform:translate(0px, 0px);z-index:9999;border:1px solid #ccc;background:#fff;padding:4px;box-shadow:0 4px 12px rgba(0,0,0,.2);border-radius:6px;pointer-events:none}.us-image-hover-preview-container>img{max-width:500px;max-height:500px;display:block}'),function(e,t){const o=document.querySelector(e);o?t(o):new MutationObserver((o,n)=>{for(const r of o)for(const o of r.addedNodes){if(!(o instanceof HTMLElement))continue;if(o.matches(e))return n.disconnect(),void t(o);const r=o.querySelector(e);if(r)return n.disconnect(),void t(r)}}).observe(document.body,{childList:!0,subtree:!0})}("#piazza_homepage_id",t=>{const o=document.createElement("a");o.href="#",o.textContent="Userscript settings",o.className="dropdown-item",o.style.cursor="pointer",o.addEventListener("click",t=>{t.preventDefault(),e.showDialog()}),t.insertAdjacentElement("afterend",o)}),function(){const e=new Map;let t=null;function o(t){if(!t||"object"!=typeof t)return;const n=[t.tag_good,t.tag_endorse].find(Boolean);t.id&&Array.isArray(n)&&n.length>0&&e.set(t.id,n);for(const e in t)if(t.hasOwnProperty(e)){const n=t[e];Array.isArray(n)?n.forEach(e=>o(e)):"object"==typeof n&&null!==n&&o(n)}}async function n(){const t=window.location.pathname.match(/\/class\/([^\/]+)\/post\/([^\/]+)/);if(e.clear(),t){const e=t[1],n=t[2],r=await fetch("https://piazza.com/logic/api?method=content.get",{credentials:"include",headers:{Accept:"application/json, text/plain, */*",Pragma:"no-cache","Cache-Control":"no-cache","CSRF-Token":unsafeWindow.CSRF_TOKEN},referrer:window.location.href,body:JSON.stringify({method:"content.get",params:{cid:n,nid:e,student_view:null}}),method:"POST",mode:"cors"});o(await r.json())}console.log(e)}function r(e){const t=e.querySelector('div[id$="_render"]');return null!=t?t.id.replace(/_render$/,""):"unknown"}async function a(o){if(o.classList.contains("endorsement-patched"))return;let a;t!=window.location.pathname&&(await n(),t=window.location.pathname);const i=o.closest('article[aria-label="Instructor Answer"]');if(i)a=r(i);else{const e=o.closest('article[id="qaContentViewId"]');if(null!=e)a=r(e);else{const e=o.closest("div[id]");null!=e&&(a=e.id)}}let s=e.get(a)??[];s=s.filter(e=>e.admin).map(e=>e.name),console.log("Found endorsement:",o,"id:",a,"info:",s),s.length>1&&(o.classList.add("endorsement-patched"),o.textContent="Endorsed by Instructors ("+s.join(", ")+")")}new MutationObserver(async e=>{for(const t of e){for(const e of t.addedNodes)if(1===e.nodeType){e.matches("div.badge-success > b")&&e.textContent.trim().startsWith("Endorsed by Instructor")&&await a(e);const t=e.querySelectorAll?.("div.badge-success > b");for(const e of t)e&&e.textContent.trim().startsWith("Endorsed by Instructor")&&await a(e)}if("characterData"===t.type){const e=t.target.parentElement;e?.matches("div.badge-success > b")&&e.textContent.trim().startsWith("Endorsed by Instructor")&&await a(e)}}}).observe(document.body,{childList:!0,subtree:!0,characterData:!0})}()})();